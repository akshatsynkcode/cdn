<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Page</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <h1>Payment</h1>
    <form id="payment-form">
        <label for="summary">Amount:</label>
        <input type="text" name="summary" placeholder="Enter amount" required>
        <button id="pay-button" type="button">Pay</button>
    </form>

    <div id="toast-container" style="display:none;">
        <div id="toast-inner-message"></div>
    </div>

    <script>
        document.getElementById('pay-button').addEventListener('click', async function(event) {
            event.preventDefault();

            const fromWalletAddress = "{{ wallet_address }}";
            const toWalletAddress = "{{ to_wallet_address }}";
            const token = "{{ token }}";
            const username = "{{ name }}";
            const extension_id = "{{ extension_id }}";
            console.log("fromWalletAddress:", fromWalletAddress);
            console.log("sessionStorage:", sessionStorage);
            console.log("token:", token);

            const amount = document.querySelector('[name="summary"]').value;
            console.log("amount:", amount);

            if (!fromWalletAddress || !toWalletAddress || !amount) {
                Swal.fire({
                    text: "Missing required information. Please check wallet addresses or amount.",
                    icon: "warning",
                    confirmButtonText: "OK"
                });
                return;
            }

            const requestData = {
                from_wallet_address: fromWalletAddress,
                to_wallet_address: toWalletAddress,
                amount: parseInt(amount, 10),
                module_id: "{{ declaration_id }}"
            };

            try {
                const response = await fetch('https://log-iam-temp.finloge.com/api/ext-transaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    verifyPayment(); // Ensure you define or replace this function based on your logic

                    chrome.runtime.sendMessage(extension_id, {
                        action: 'transaction_request',
                        username: username,
                        fromAddress: fromWalletAddress,
                        toAddress: toWalletAddress,
                        amount: amount,
                        authToken: token,
                        transaction_id: responseData['transaction_id']
                    }, function(response) {
                        if (response.success) {
                            Swal.fire({
                                text: "Transaction request sent for approval.",
                                icon: "success",
                                confirmButtonText: "OK"
                            });
                        } else {
                            Swal.fire({
                                text: response.message || "Transaction request failed.",
                                icon: "error",
                                confirmButtonText: "OK"
                            });
                        }
                    });

                    console.log("responseData:", responseData);
                } else {
                    showToastMessage("Payment failed. Please try again.", "error");
                }
            } catch (error) {
                console.error('Error:', error);
                showToastMessage("An error occurred while processing the payment.", "error");
            }
        });

        function showToastMessage(message, type) {
            const toastContainer = document.getElementById("toast-container");
            const toastMessageElement = document.getElementById("toast-inner-message");
            toastMessageElement.textContent = message;
            toastContainer.style.display = "block";
            toastContainer.style.backgroundColor = type === "error" ? "#f44336" : "#4CAF50";
            setTimeout(() => toastContainer.style.display = "none", 3000);
        }
    </script>
</body>
</html>
